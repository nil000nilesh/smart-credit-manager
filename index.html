<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Credit Manager</title>
    <meta name="theme-color" content="#0f172a">
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Crypto JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>

    <!-- 4. Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.292.0"
      }
    }
    </script>

    <style>
        body { background-color: #f1f5f9; touch-action: manipulation; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .chat-bubble { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; margin-bottom: 8px; }
        .chat-user { background-color: #2563eb; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background-color: #ffffff; color: #1e293b; align-self: flex-start; border: 1px solid #e2e8f0; border-bottom-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- MAIN REACT APPLICATION -->
    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
            getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut
        } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, query, orderBy, onSnapshot, updateDoc, doc, serverTimestamp, deleteDoc, getDoc, setDoc
        } from 'firebase/firestore';
        import { 
            Lock, Unlock, Send, FileText, Users, Key, StickyNote, History, Settings, LogOut, 
            ShieldCheck, BrainCircuit, X, Menu, CheckCircle, Clock, AlertTriangle, ChevronRight, 
            Briefcase, Phone, CreditCard, FolderOpen, RefreshCw, Power, MessageSquare, Bot
        } from 'lucide-react';

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBz9bUrnOMu6I_OQ2cTHsRbVJUGlNs9c_E",
            authDomain: "wisfox-lead-app.firebaseapp.com",
            projectId: "wisfox-lead-app",
            storageBucket: "wisfox-lead-app.firebasestorage.app",
            messagingSenderId: "54162755199",
            appId: "1:54162755199:web:80ebc15aae5584383bb94a"
        };

        const MY_ALLOWED_EMAIL = "nil000nilesh@gmail.com"; 
        
        // --- SECURITY: DO NOT PASTE KEY HERE FOR GITHUB ---
        // Use the 'Settings' menu in the App UI to save the key safely in your browser.
        const FIXED_OPENAI_KEY = ""; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "credit-manager-v2"; 

        // --- ENCRYPTION HELPERS ---
        const encryptData = (text, pin) => {
            if (!text || !pin || !window.CryptoJS) return text;
            return window.CryptoJS.AES.encrypt(text, pin).toString();
        };

        const decryptData = (cipherText, pin) => {
            if (!cipherText || !pin || !window.CryptoJS) return cipherText;
            try {
                const bytes = window.CryptoJS.AES.decrypt(cipherText, pin);
                const originalText = bytes.toString(window.CryptoJS.enc.Utf8);
                return originalText || '';
            } catch (e) {
                return ''; 
            }
        };

        // --- SMART AI LOGIC (Conversational) ---
        const processWithChatAI = async (chatHistory, apiKey, masterKey, existingClients) => {
            if (!apiKey) throw new Error("API Key Missing. Go to Settings to add it.");

            const clientsList = existingClients.map(c => `${c.name} (Status: ${c.fileStatus})`).join(", ");
            
            const systemPrompt = `
                You are a smart assistant for a Bank Credit Manager.
                
                CURRENT DATABASE CLIENTS: [${clientsList}].
                
                YOUR GOAL: Organize data into the database.
                
                INSTRUCTIONS:
                1. Analyze the conversation history.
                2. If the user's request is ambiguous (e.g., "Update Sharma" but there are multiple Sharmas or no Sharma), ASK a clarifying question.
                3. If the user mentions a NEW name, ask for confirmation/details before creating, OR if they provided details (Mobile/Loan amt), go ahead and create.
                4. Only when you have clear details, output a JSON object. Otherwise, output plain text (the question).
                
                JSON FORMAT (Only when executing action):
                {
                    "isAction": true,
                    "responseMessage": "Success message to show user",
                    "data": {
                        "type": "assignment" | "note" | "contact" | "password",
                        "action": "create_client" | "update_client" | "create_task",
                        "title": "Short summary",
                        "content": "Detailed content",
                        "priority": "high" | "medium" | "low",
                        "clientData": {
                            "name": "Extracted Name",
                            "mobile": "Extracted Mobile",
                            "account": "Extracted Account",
                            "status": "Login" | "Sanction" | "Disbursement" | "Audit" | "Closed",
                            "remarks": "Any extra info"
                        }
                    }
                }
                
                PLAIN TEXT FORMAT (When asking question):
                "Just type the question here..."
            `;

            // Convert chat history for OpenAI
            const messages = [
                { role: "system", content: systemPrompt },
                ...chatHistory.map(msg => ({ role: msg.role === 'ai' ? 'assistant' : 'user', content: msg.text }))
            ];

            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: "gpt-4o-mini",
                    messages: messages
                })
            });
            
            const data = await response.json();
            const content = data.choices[0].message.content;

            try {
                // Try to parse JSON (Action)
                const jsonAction = JSON.parse(content);
                if (jsonAction.isAction) return { type: 'action', payload: jsonAction };
            } catch (e) {
                // It's a text response (Question)
                return { type: 'question', text: content };
            }
            return { type: 'question', text: content };
        };

        // --- COMPONENTS ---
        const MainApp = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);
            
            // Security State
            const [sessionPin, setSessionPin] = useState(null); 
            const [masterKey, setMasterKey] = useState(null); 
            const [securityMode, setSecurityMode] = useState('loading'); 
            
            // Data State
            const [currentView, setCurrentView] = useState('dashboard');
            const [items, setItems] = useState([]);
            const [clients, setClients] = useState([]);
            
            // Chat State
            const [chatOpen, setChatOpen] = useState(false);
            const [chatHistory, setChatHistory] = useState([{ role: 'ai', text: 'Hello! Mai aapka Credit Assistant hu. Bataiye aaj kya update karna hai?' }]);
            const [inputText, setInputText] = useState("");
            const [aiProcessing, setAiProcessing] = useState(false);
            
            // API Key Logic: Check Fixed Key first, then LocalStorage
            const [apiKey, setApiKey] = useState(FIXED_OPENAI_KEY || localStorage.getItem('openai_api_key') || "");
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const chatEndRef = useRef(null);

            // Auto Logout Ref
            const logoutTimerRef = useRef(null);

            // Auth Listener
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        if (u.email !== MY_ALLOWED_EMAIL) {
                            setAuthError(`Access Denied: ${u.email}`);
                            signOut(auth);
                        } else {
                            setUser(u);
                            checkSecurityStatus(u.uid);
                        }
                    } else {
                        setUser(null);
                        setLoading(false);
                        setMasterKey(null);
                        setSessionPin(null);
                    }
                });
                return () => unsubscribe();
            }, []);

            // Scroll Chat
            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [chatHistory, chatOpen]);

            // Data Listeners
            useEffect(() => {
                if (!user || !masterKey) return;

                const qItems = query(collection(db, 'artifacts', appId, 'users', user.uid, 'items'), orderBy('createdAt', 'desc'));
                const unsubItems = onSnapshot(qItems, (snap) => {
                    setItems(snap.docs.map(d => {
                        const data = d.data();
                        return {
                            id: d.id, ...data,
                            title: decryptData(data.title, masterKey),
                            content: decryptData(data.content, masterKey),
                            clientName: decryptData(data.clientName, masterKey)
                        };
                    }));
                });

                const qClients = query(collection(db, 'artifacts', appId, 'users', user.uid, 'clients'), orderBy('updatedAt', 'desc'));
                const unsubClients = onSnapshot(qClients, (snap) => {
                    setClients(snap.docs.map(d => {
                        const data = d.data();
                        return {
                            id: d.id, ...data,
                            name: decryptData(data.name, masterKey),
                            accountNo: decryptData(data.accountNo, masterKey),
                            mobile: decryptData(data.mobile, masterKey),
                            remarks: decryptData(data.remarks, masterKey)
                        };
                    }));
                });

                return () => { unsubItems(); unsubClients(); };
            }, [user, masterKey]);

            // Auto Logout
            useEffect(() => {
                if (!user || !masterKey) return;
                const resetTimer = () => {
                    if (logoutTimerRef.current) clearTimeout(logoutTimerRef.current);
                    logoutTimerRef.current = setTimeout(() => {
                        setMasterKey(null);
                        setSessionPin(null);
                        setSecurityMode('login'); 
                    }, 5 * 60 * 1000); // 5 Minutes
                };
                window.addEventListener('mousemove', resetTimer);
                window.addEventListener('keypress', resetTimer);
                window.addEventListener('click', resetTimer);
                resetTimer(); 
                return () => {
                    if (logoutTimerRef.current) clearTimeout(logoutTimerRef.current);
                    window.removeEventListener('mousemove', resetTimer);
                    window.removeEventListener('keypress', resetTimer);
                    window.removeEventListener('click', resetTimer);
                };
            }, [user, masterKey]);


            // --- SECURITY LOGIC ---
            const checkSecurityStatus = async (uid) => {
                const docRef = doc(db, 'artifacts', appId, 'users', uid, 'security', 'config');
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    setSecurityMode('setup'); 
                } else {
                    const data = docSnap.data();
                    if (data.lastLoginDate !== new Date().toDateString()) {
                        setSecurityMode('daily_reset'); 
                    } else {
                        setSecurityMode('login'); 
                    }
                }
                setLoading(false);
            };

            const handlePinSetup = async (newPin, oldPinForRecovery = null) => {
                if (!/^\d{4}$/.test(newPin)) { alert("PIN must be exactly 4 digits."); return; }
                const uid = user.uid;
                const docRef = doc(db, 'artifacts', appId, 'users', uid, 'security', 'config');
                const docSnap = await getDoc(docRef);
                
                let history = [];
                let newMasterKey = "";

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    history = data.pinHistory || [];
                    if (history.includes(newPin)) {
                        alert("Risk: Last 5 PINs cannot be reused.");
                        return;
                    }
                    if (securityMode === 'daily_reset') {
                         if(!oldPinForRecovery) { alert("Enter yesterday's PIN."); return; }
                         const encryptedMaster = data.encryptedMasterKey;
                         newMasterKey = decryptData(encryptedMaster, oldPinForRecovery);
                         if (!newMasterKey) { alert("Wrong Old PIN."); return; }
                    }
                } else {
                    newMasterKey = Math.random().toString(36).substring(2);
                }

                const encryptedMasterKey = encryptData(newMasterKey, newPin);
                await setDoc(docRef, {
                    encryptedMasterKey: encryptedMasterKey,
                    lastLoginDate: new Date().toDateString(),
                    pinHistory: [newPin, ...history].slice(0, 5) 
                });
                setMasterKey(newMasterKey);
                setSessionPin(newPin);
                setSecurityMode('active');
            };

            const handleLogin = async (inputPin) => {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'security', 'config');
                const docSnap = await getDoc(docRef);
                const data = docSnap.data();
                const decrypted = decryptData(data.encryptedMasterKey, inputPin);
                if (decrypted) {
                    setMasterKey(decrypted);
                    setSessionPin(inputPin);
                    setSecurityMode('active');
                } else {
                    alert("Wrong PIN!");
                }
            };

            // --- UI ACTIONS ---
            const handleAddClient = async (e) => {
                e.preventDefault();
                const form = e.target;
                const newClient = {
                    name: encryptData(form.name.value, masterKey),
                    accountNo: encryptData(form.account.value, masterKey),
                    mobile: encryptData(form.mobile.value, masterKey),
                    fileStatus: form.status.value,
                    fileLevel: form.level.value,
                    remarks: encryptData(form.remarks.value, masterKey),
                    updatedAt: serverTimestamp()
                };
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'clients'), newClient);
                form.reset();
            };

            // --- CHAT HANDLER ---
            const handleChatSubmit = async (e) => {
                e.preventDefault();
                if (!inputText.trim()) return;
                
                const userMsg = { role: 'user', text: inputText };
                const updatedHistory = [...chatHistory, userMsg];
                setChatHistory(updatedHistory);
                setInputText("");
                setAiProcessing(true);
                
                try {
                    const result = await processWithChatAI(updatedHistory, apiKey, masterKey, clients);
                    
                    if (result.type === 'question') {
                        // AI asks clarification
                        setChatHistory(prev => [...prev, { role: 'ai', text: result.text }]);
                    } 
                    else if (result.type === 'action') {
                        // AI executes
                        const payload = result.payload.data;
                        const cData = payload.clientData || {};
                        const message = result.payload.responseMessage || "Task completed.";

                        // 1. Client Actions
                        if (payload.action === 'create_client' && cData.name) {
                             const newClient = {
                                name: encryptData(cData.name, masterKey),
                                accountNo: encryptData(cData.account || '', masterKey),
                                mobile: encryptData(cData.mobile || '', masterKey),
                                fileStatus: cData.status || 'Login',
                                fileLevel: 'Branch Level',
                                remarks: encryptData(cData.remarks || 'Created via AI', masterKey),
                                updatedAt: serverTimestamp()
                            };
                            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'clients'), newClient);
                        }
                        if (payload.action === 'update_client' && cData.name) {
                            const existing = clients.find(c => c.name.toLowerCase().includes(cData.name.toLowerCase()));
                            if (existing) {
                                const updates = { updatedAt: serverTimestamp() };
                                if (cData.status) updates.fileStatus = cData.status;
                                if (cData.mobile) updates.mobile = encryptData(cData.mobile, masterKey);
                                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'clients', existing.id), updates);
                            }
                        }

                        // 2. Task Actions
                        if (payload.type !== 'contact') {
                             await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'items'), {
                                type: payload.type || 'note',
                                title: encryptData(payload.title, masterKey),
                                content: encryptData(payload.content, masterKey),
                                clientName: encryptData(cData.name || '', masterKey),
                                priority: payload.priority || 'medium',
                                status: 'pending',
                                createdAt: serverTimestamp(),
                                dateString: new Date().toLocaleDateString()
                            });
                        }

                        setChatHistory(prev => [...prev, { role: 'ai', text: `✅ ${message}` }]);
                    }

                } catch (error) {
                    setChatHistory(prev => [...prev, { role: 'ai', text: `Error: ${error.message}. Check Settings > API Key.` }]);
                } finally {
                    setAiProcessing(false);
                }
            };

            const deleteItem = async (col, id) => {
                if(confirm("Permanently delete?")) await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, col, id));
            };

            // --- RENDER ---
            if (loading) return <div className="h-screen bg-slate-900 flex items-center justify-center text-white">Loading...</div>;

            if (!user) return (
                <div className="h-screen bg-slate-900 flex items-center justify-center p-4">
                     <div className="bg-white/10 backdrop-blur-md p-10 rounded-3xl text-center border border-white/20">
                         <ShieldCheck size={50} className="text-blue-500 mx-auto mb-4"/>
                         <h1 className="text-2xl font-bold text-white mb-8">Smart Credit Manager</h1>
                         <button onClick={() => signInWithPopup(auth, new GoogleAuthProvider())} className="bg-white text-black px-6 py-3 rounded-xl font-bold flex gap-2 mx-auto hover:scale-105 transition">
                            <img src="https://www.google.com/favicon.ico" className="w-5 h-5"/> Sign in with Google
                         </button>
                         {authError && <p className="mt-4 text-red-400 text-sm">{authError}</p>}
                     </div>
                </div>
            );

            if (securityMode !== 'active') return (
                securityMode === 'login' ? <LoginScreen onLogin={handleLogin}/> : <PinSetupScreen onSet={handlePinSetup} mode={securityMode} />
            );

            // MAIN APP
            return (
                <div className="flex h-screen bg-slate-100 font-sans text-slate-800 overflow-hidden">
                    {/* SIDEBAR */}
                    <aside className={`fixed inset-y-0 left-0 z-50 w-72 bg-slate-900 text-white transform transition-transform duration-300 ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col shadow-2xl`}>
                        <div className="p-6 border-b border-white/10 flex justify-between items-center bg-slate-950">
                            <h1 className="text-xl font-bold flex gap-2 tracking-wider"><Briefcase className="text-blue-500"/> CREDIT MGR</h1>
                            <button onClick={()=>setSidebarOpen(false)} className="md:hidden"><X/></button>
                        </div>
                        <div className="p-6 pb-2">
                             <div className="bg-white/5 border border-white/10 rounded-xl p-4 flex items-center gap-3">
                                 <img src={user.photoURL} className="w-10 h-10 rounded-full border-2 border-blue-500"/>
                                 <div className="overflow-hidden">
                                     <p className="text-sm font-bold truncate">{user.displayName}</p>
                                     <p className="text-[10px] text-slate-400 truncate">Manager • Online</p>
                                 </div>
                             </div>
                        </div>
                        <nav className="flex-1 p-4 space-y-2 overflow-y-auto">
                            <NavBtn id="dashboard" icon={StickyNote} label="Assignments" current={currentView} set={setCurrentView}/>
                            <NavBtn id="clients" icon={FolderOpen} label="Files / Clients" current={currentView} set={setCurrentView}/>
                            <NavBtn id="history" icon={History} label="History" current={currentView} set={setCurrentView}/>
                            <NavBtn id="vault" icon={Lock} label="Passwords" current={currentView} set={setCurrentView}/>
                        </nav>
                        <div className="p-4 bg-slate-950 border-t border-white/10">
                            <button onClick={()=>{setSecurityMode('login'); setMasterKey(null);}} className="w-full flex items-center gap-3 text-slate-400 hover:text-white hover:bg-white/5 p-3 rounded-lg transition-all">
                                <Power size={18}/> Lock Session
                            </button>
                        </div>
                    </aside>

                    {/* CONTENT */}
                    <main className="flex-1 flex flex-col relative h-full bg-[#f1f5f9]">
                        <header className="bg-white border-b border-slate-200 p-4 flex justify-between items-center shadow-sm sticky top-0 z-30">
                            <div className="flex items-center gap-3">
                                <button onClick={()=>setSidebarOpen(true)} className="md:hidden p-2 hover:bg-slate-100 rounded-lg"><Menu/></button>
                                <h2 className="font-bold capitalize text-xl text-slate-800">{currentView === 'clients' ? 'Client Files' : currentView}</h2>
                            </div>
                            <div className="flex items-center gap-2 text-[10px] font-bold tracking-wider bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-full border border-emerald-200 shadow-sm">
                                <ShieldCheck size={12}/> ENCRYPTED
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 md:p-8 pb-32">
                            {/* VIEWS */}
                            {currentView === 'dashboard' && <DashboardView items={items} clients={clients} deleteItem={deleteItem} db={db} appId={appId} uid={user.uid} />}
                            {currentView === 'clients' && <ClientsView clients={clients} deleteItem={deleteItem} handleAddClient={handleAddClient} />}
                            {currentView === 'vault' && <VaultView items={items} deleteItem={deleteItem} />}
                            {currentView === 'history' && <HistoryView items={items} />}
                            {currentView === 'settings' && (
                                <div className="max-w-md mx-auto bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                                    <div className="flex items-center gap-3 mb-6">
                                        <div className="bg-purple-100 p-2 rounded-lg text-purple-600"><BrainCircuit size={24}/></div>
                                        <h3 className="font-bold text-lg">Configuration</h3>
                                    </div>
                                    <label className="block text-sm font-bold text-slate-600 mb-2">OpenAI API Key</label>
                                    <input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)} className="w-full border border-slate-200 bg-slate-50 p-3 rounded-xl mb-4 focus:bg-white focus:ring-2 ring-blue-500 outline-none transition-all" placeholder="sk-..."/>
                                    <button onClick={()=>{localStorage.setItem('openai_api_key', apiKey); alert("Saved")}} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all">Save Key</button>
                                </div>
                            )}
                        </div>

                        {/* CHAT INTERFACE (Replaces Magic Input) */}
                        <div className={`fixed bottom-0 right-0 left-0 md:left-72 bg-white border-t border-slate-200 shadow-2xl transition-all duration-300 z-40 ${chatOpen ? 'h-[500px]' : 'h-16'}`}>
                            {/* Chat Header */}
                            <div 
                                onClick={() => setChatOpen(!chatOpen)} 
                                className="h-16 flex items-center justify-between px-6 cursor-pointer hover:bg-slate-50 border-b border-slate-100"
                            >
                                <div className="flex items-center gap-3">
                                    <div className="bg-blue-600 p-2 rounded-full text-white"><Bot size={20}/></div>
                                    <div>
                                        <h3 className="font-bold text-slate-800">AI Assistant</h3>
                                        {!chatOpen && <p className="text-xs text-slate-500">Tap to chat or create tasks...</p>}
                                    </div>
                                </div>
                                <div className="text-slate-400">{chatOpen ? <X size={20}/> : <MessageSquare size={20}/>}</div>
                            </div>

                            {/* Chat Body */}
                            {chatOpen && (
                                <div className="h-[calc(100%-120px)] overflow-y-auto p-4 bg-slate-50 space-y-4">
                                    {chatHistory.map((msg, i) => (
                                        <div key={i} className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                            <div className={`chat-bubble ${msg.role === 'user' ? 'chat-user' : 'chat-ai'}`}>
                                                {msg.text}
                                            </div>
                                        </div>
                                    ))}
                                    {aiProcessing && (
                                        <div className="flex items-center gap-2 text-xs text-slate-400 ml-2">
                                            <div className="animate-spin w-3 h-3 border-2 border-blue-500 rounded-full border-t-transparent"/> AI is thinking...
                                        </div>
                                    )}
                                    <div ref={chatEndRef}></div>
                                </div>
                            )}

                            {/* Chat Input */}
                            <div className="absolute bottom-0 left-0 right-0 p-3 bg-white border-t border-slate-100">
                                <form onSubmit={handleChatSubmit} className="relative">
                                    <input 
                                        value={inputText} onChange={e=>setInputText(e.target.value)} disabled={aiProcessing}
                                        placeholder="Type here... (e.g., 'New file for Ramesh')"
                                        className="w-full bg-slate-100 border-0 rounded-full pl-5 pr-14 py-3 focus:ring-2 ring-blue-500 outline-none text-slate-700"
                                    />
                                    <button type="submit" disabled={!inputText || aiProcessing} className="absolute right-2 top-1.5 p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition disabled:bg-slate-300">
                                        <Send size={16}/>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        // --- SUB VIEWS ---
        const DashboardView = ({ items, clients, deleteItem, db, appId, uid }) => (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                {items.filter(i => ['assignment','note'].includes(i.type)).map(item => (
                    <div key={item.id} className="bg-white p-6 rounded-2xl border border-slate-200 hover:shadow-lg transition-all group relative">
                        <div className="flex justify-between items-start mb-3">
                            <span className={`text-[10px] px-2.5 py-1 rounded-full uppercase font-bold ${item.type==='assignment'?'bg-blue-50 text-blue-600':'bg-amber-50 text-amber-600'}`}>{item.type}</span>
                            <button onClick={()=>deleteItem('items', item.id)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><X size={16}/></button>
                        </div>
                        <h3 className={`font-bold text-lg mb-1 ${item.status==='done' && 'line-through text-slate-400'}`}>{item.title}</h3>
                        <p className="text-sm text-slate-500 mb-5">{item.content}</p>
                        
                        {item.clientName && (
                            <div className="mb-4 bg-slate-50 p-2 rounded-lg text-xs text-slate-700 flex items-center justify-between">
                                <span className="font-bold flex items-center gap-2"><Users size={14}/> {item.clientName}</span>
                                {(() => {
                                    const c = clients.find(cl => cl.name === item.clientName);
                                    return c ? <span className="bg-white border px-1 rounded">{c.fileStatus}</span> : null;
                                })()}
                            </div>
                        )}

                        <button onClick={()=>updateDoc(doc(db, 'artifacts', appId, 'users', uid, 'items', item.id), { status: item.status==='pending'?'done':'pending' })} className={`w-full py-2.5 rounded-xl font-bold text-sm ${item.status==='done'?'bg-slate-100 text-slate-500':'bg-slate-900 text-white'}`}>
                            {item.status==='done' ? 'Completed' : 'Mark Done'}
                        </button>
                    </div>
                ))}
            </div>
        );

        const ClientsView = ({ clients, deleteItem, handleAddClient }) => (
            <div className="space-y-8">
                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h3 className="font-bold mb-6 text-lg">New Client File</h3>
                    <form onSubmit={handleAddClient} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input name="name" placeholder="Name" required className="border p-3 rounded-xl bg-slate-50" />
                        <input name="account" placeholder="Acc No" className="border p-3 rounded-xl bg-slate-50" />
                        <input name="mobile" placeholder="Mobile" className="border p-3 rounded-xl bg-slate-50" />
                        <select name="status" className="border p-3 rounded-xl bg-slate-50">
                            <option>Login</option><option>Sanction</option><option>Disbursement</option>
                        </select>
                        <select name="level" className="border p-3 rounded-xl bg-slate-50">
                            <option>Branch Level</option><option>RO Level</option>
                        </select>
                        <input name="remarks" placeholder="Remarks" className="border p-3 rounded-xl bg-slate-50 md:col-span-2" />
                        <button className="md:col-span-2 bg-slate-900 text-white py-3 rounded-xl font-bold">Create File</button>
                    </form>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                    {clients.map(client => (
                        <div key={client.id} className="bg-white p-6 rounded-2xl border border-slate-200 hover:border-blue-400 transition-all shadow-sm group">
                            <div className="flex justify-between items-start mb-4">
                                <div className="flex items-center gap-4">
                                    <div className="w-12 h-12 rounded-2xl bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xl">{client.name.charAt(0)}</div>
                                    <div><h4 className="font-bold text-lg">{client.name}</h4><span className="text-xs bg-gray-100 px-2 py-1 rounded-full font-bold">{client.fileStatus}</span></div>
                                </div>
                                <button onClick={()=>deleteItem('clients', client.id)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><X size={18}/></button>
                            </div>
                            <div className="grid grid-cols-2 gap-2 text-sm text-slate-500 bg-slate-50 p-3 rounded-lg">
                                <div><span className="font-bold">Mob:</span> {client.mobile}</div>
                                <div><span className="font-bold">Acc:</span> {client.accountNo}</div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const VaultView = ({ items, deleteItem }) => (
            <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                {items.filter(i => i.type === 'password').map(item => (
                    <div key={item.id} className="bg-slate-800 text-slate-200 p-6 rounded-2xl relative group border border-slate-700 shadow-xl">
                        <button onClick={()=>deleteItem('items', item.id)} className="absolute top-4 right-4 text-slate-500 hover:text-white"><X size={18}/></button>
                        <div className="flex items-center gap-2 text-blue-400 font-bold text-[10px] uppercase tracking-widest mb-3"><Key size={12}/> Credential</div>
                        <h3 className="font-bold text-white text-lg mb-2">{item.title}</h3>
                        <div className="bg-slate-950 p-3 rounded-lg font-mono text-sm break-all border border-slate-700/50">{item.content}</div>
                    </div>
                ))}
            </div>
        );
        
        const HistoryView = ({ items }) => (
            <div className="space-y-4">
                {items.map(item => (
                    <div key={item.id} className="bg-white p-4 rounded-xl border flex justify-between items-center">
                        <div>
                            <p className="font-bold">{item.title}</p>
                            <p className="text-xs text-slate-400">{item.dateString} • {item.type}</p>
                        </div>
                        <span className={`px-2 py-1 rounded text-xs ${item.status==='done'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>{item.status}</span>
                    </div>
                ))}
            </div>
        );

        // Security Screens (Simplified for brevity as they are same as before)
        const PinSetupScreen = ({ onSet, mode }) => {
            const [p1, setP1] = useState(''); const [p2, setP2] = useState('');
            return (
                <div className="h-screen bg-slate-50 flex items-center justify-center p-4">
                    <div className="bg-white p-10 rounded-3xl shadow-xl max-w-sm w-full text-center">
                        <h2 className="text-2xl font-bold mb-4">{mode === 'setup' ? 'Set PIN' : 'Daily Reset'}</h2>
                        <form onSubmit={(e)=>{e.preventDefault(); onSet(p1, p2)}} className="space-y-4">
                            {mode === 'daily_reset' && <input type="password" maxLength="4" placeholder="Old PIN" value={p2} onChange={e=>setP2(e.target.value)} className="w-full border p-4 rounded-xl text-center text-lg"/>}
                            <input type="password" maxLength="4" placeholder="New PIN" value={p1} onChange={e=>setP1(e.target.value)} className="w-full border p-4 rounded-xl text-center text-lg font-bold"/>
                            <button className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">Confirm</button>
                        </form>
                    </div>
                </div>
            )
        };

        const LoginScreen = ({ onLogin }) => {
            const [pin, setPin] = useState('');
            return (
                <div className="h-screen bg-slate-50 flex items-center justify-center p-4">
                    <div className="bg-white p-10 rounded-3xl shadow-xl max-w-xs w-full text-center">
                        <h2 className="text-xl font-bold mb-6">Enter PIN</h2>
                        <form onSubmit={(e)=>{e.preventDefault(); onLogin(pin)}}>
                            <input type="password" maxLength="4" autoFocus value={pin} onChange={e=>setPin(e.target.value)} className="w-full border p-4 rounded-xl text-center text-3xl font-bold mb-6"/>
                            <button className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold">Unlock</button>
                        </form>
                    </div>
                </div>
            )
        };

        const NavBtn = ({ id, icon: Icon, label, current, set }) => (
            <button onClick={()=>{set(id); if(id==='settings') setTimeout(()=>alert('To add API Key, go to Settings'),100)}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-medium ${current===id ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>
                <Icon size={20}/> <span>{label}</span>
                {current===id && <ChevronRight size={16} className="ml-auto opacity-50"/>}
            </button>
        );

        const root = createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
